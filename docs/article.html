<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.ico"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="apple-touch-icon" href="/logo192.png"/>
  <title>GYCO — Home</title>

  <!-- Normalize + Bootstrap + Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <style>
    :root { --accent:#0d6efd; }
    body { background:#fff; color:#111; }
    .focus-outline:focus-visible { outline: none; box-shadow: 0 0 0 .25rem rgba(13,110,253,.18); border-radius:.25rem; }
    .sr-only { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0,0,0,0) !important; white-space:nowrap !important; border:0 !important; }
    .card-img-hero { width:100%; height:360px; object-fit:cover; border-radius:.5rem; display:block; }
    .meta-muted { color:#6c757d; font-size:.95rem; }
    .related-item { text-decoration:none; color:inherit; }
    .article-tools { border-top:1px solid #e9ecef; padding-top:.75rem; margin-top:1rem; display:flex; justify-content:space-between; align-items:center; gap:.5rem; }
    .empty-state { color:#6c757d; }
  </style>
</head>
<body>
  <!-- NAV (no hard-coded active) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom" aria-label="Main navigation">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/index.html" aria-label="GYCO home">
        <img src="https://picsum.photos/36" alt="logo">
        <span class="fw-bold">GYCO</span>
      </a>

      <button class="navbar-toggler focus-outline" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/articles.html">Articles</a></li>
          <li class="nav-item dropdown">
            <button class="btn btn-light dropdown-toggle ms-2 focus-outline" id="userMenuBtn" data-bs-toggle="dropdown" aria-expanded="false" type="button">
              <i class="fa-solid fa-user" aria-hidden="true"></i><span class="visually-hidden"> User menu</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuBtn">
              <li><a class="dropdown-item" href="#">Profile</a></li>
              <li><a class="dropdown-item" href="#">My Articles</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#">Logout</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="container my-4" role="main">
    <!-- Search -->
    <div class="row mb-3">
      <div class="col-12 col-lg-8 mx-auto">
        <form id="searchForm" role="search" aria-label="Search articles">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i></span>
            <input id="searchInput" class="form-control" type="search" placeholder="Search articles..." aria-label="Search articles" />
            <button class="btn btn-outline-secondary" type="submit">Search</button>
          </div>
        </form>
      </div>
    </div>

    <div class="row">
      <!-- Article column -->
      <div class="col-12 col-lg-8">
        <!-- Container where external article HTML will be injected -->
        <div id="articleContainer" aria-live="polite" aria-atomic="true">
          <div id="loadingState" class="mb-4">
            <h1 id="articleTitle" class="h3 mb-2">Loading…</h1>
            <div class="meta-muted mb-3">By <span id="articleAuthor">—</span> • <time id="articleDate">—</time></div>
            <div class="lead">Loading content…</div>
          </div>
        </div>

        <!-- Missing content prompt -->
        <div id="missingAlert" class="alert alert-warning d-none" role="alert" aria-live="polite">
          This article does not have content yet. You can <button id="openRequestFromMissing" class="btn btn-sm btn-link p-0" data-bs-toggle="modal" data-bs-target="#requestModal">request similar content</button> or return to the <a href="/articles.html">articles list</a>.
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="col-12 col-lg-4">
        <div class="sticky-top" style="top:1rem;">
          <div class="mb-3">
            <h6 class="text-uppercase small text-muted">Related</h6>
            <div id="relatedList" class="list-group" aria-live="polite" aria-atomic="true">
              <div class="small text-muted">Loading related…</div>
            </div>
          </div>

          <div class="mb-3">
            <button id="requestSimilarBtn" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#requestModal">Request similar</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Footer + shared modal + toast (minimal) -->
  <footer class="bg-white border-top">
    <div class="container py-3 d-flex flex-column flex-md-row justify-content-between align-items-center">
      <div class="small text-muted">© 2025 Greater Youth Collaborative Opus</div>
      <nav aria-label="Footer">
        <a class="text-decoration-none small me-3" href="/index.html">About</a>
        <a class="text-decoration-none small me-3" href="/index.html">Contact</a>
        <a class="text-decoration-none small" href="/index.html">Privacy Policy</a>
      </nav>
    </div>
  </footer>

  <!-- Add / Request modal (same pattern as index) -->
  <div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="requestForm" class="modal-content needs-validation" novalidate>
        <div class="modal-header">
          <h5 class="modal-title" id="requestModalLabel">Request an Article</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label for="reqTitle" class="form-label">Article Title</label>
            <input id="reqTitle" name="title" class="form-control" type="text" required maxlength="150" />
            <div class="invalid-feedback">Please add a title (max 150 chars).</div>
          </div>
          <div class="mb-3">
            <label for="reqDesc" class="form-label">Description</label>
            <textarea id="reqDesc" name="description" class="form-control" rows="4" required></textarea>
            <div class="invalid-feedback">Please add a description.</div>
          </div>
          <div class="mb-3">
            <label for="reqTags" class="form-label">Tags</label>
            <input id="reqTags" name="tags" class="form-control" placeholder="e.g. research, design" />
            <div class="form-text">Separate tags with commas.</div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="submitRequest" class="btn btn-primary" type="submit">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080;">
    <div id="submitToast" class="toast align-items-center text-white bg-success border-0" role="status" aria-live="polite" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">Request submitted.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Page script -->
  <script>
  (function () {
    'use strict';

    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const ARTICLE_DIR = '/content/articles/';
    const INDEX_JSON = '/content/articles.json';
    const VIEWS_KEY = 'articleViews_v1';

    // NAV activation (same robust behaviour)
    function normalizeForCompare(p) {
      if (!p) p = '/';
      p = p.split('#')[0];
      if (!p.includes('?') && p.endsWith('/')) p = p + 'index.html';
      if (p === '/') p = '/index.html';
      p = p.replace(/\/+/g, '/');
      return p;
    }
    function activateNavLinks() {
      const navLinks = Array.from(document.querySelectorAll('.navbar-nav .nav-link'));
      if (!navLinks.length) return;
      const currPath = normalizeForCompare(location.pathname + (location.search || ''));
      navLinks.forEach(a => { a.classList.remove('active'); a.removeAttribute('aria-current'); });
      let matched = null;
      for (const a of navLinks) {
        try {
          const url = new URL(a.getAttribute('href'), location.href);
          if (url.origin !== location.origin) continue;
          const linkNorm = normalizeForCompare(url.pathname + (url.search || ''));
          if (linkNorm === currPath) { matched = a; break; }
        } catch (e) {}
      }
      if (!matched) {
        const currPathNoQuery = normalizeForCompare(location.pathname);
        for (const a of navLinks) {
          try {
            const url = new URL(a.getAttribute('href'), location.href);
            if (url.origin !== location.origin) continue;
            const linkNorm = normalizeForCompare(url.pathname);
            if (linkNorm === currPathNoQuery) { matched = a; break; }
          } catch (e) {}
        }
      }
      if (!matched) {
        const currFile = (location.pathname || '').split('/').pop() || 'index.html';
        for (const a of navLinks) {
          try {
            const url = new URL(a.getAttribute('href'), location.href);
            if (url.origin !== location.origin) continue;
            const linkFile = (url.pathname || '').split('/').pop() || 'index.html';
            if (linkFile === currFile) { matched = a; break; }
          } catch (e) {}
        }
      }
      if (matched) { matched.classList.add('active'); matched.setAttribute('aria-current','page'); }
    }

    // Views storage
    function loadViews(){ try { return JSON.parse(localStorage.getItem(VIEWS_KEY) || '{}'); } catch(e){ return {}; } }
    function saveViews(obj){ try { localStorage.setItem(VIEWS_KEY, JSON.stringify(obj)); } catch(e){} }
    function incrementView(id){
      if (!id) return;
      const obj = loadViews();
      obj[id] = (obj[id] || 0) + 1;
      saveViews(obj);
      updateViewUI(id);
    }
    function updateViewUI(id){
      const el = qs('#articleToolsViewCount');
      if (el) el.textContent = `Views: ${ (loadViews()[id] || 0) }`;
    }

    // Helpers
    function currentIdFromURL(){ return (new URLSearchParams(location.search)).get('id') || ''; }
    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Fetch index (used to compute related)
    async function fetchIndex(){
      try {
        const r = await fetch(INDEX_JSON);
        if (!r.ok) return [];
        const j = await r.json();
        return Array.isArray(j) ? j : [];
      } catch (e) { return []; }
    }

    // Fetch article HTML file by id
    async function fetchArticleHtmlById(id){
      if (!id) return null;
      const path = `${ARTICLE_DIR}${encodeURIComponent(id)}.html`;
      try {
        const r = await fetch(path);
        if (!r.ok) return null;
        const text = await r.text();
        return { html: text, path };
      } catch (e) { return null; }
    }

    // Inject HTML safely: parse DOM, import nodes to current document
    function injectHtmlIntoContainer(html, container){
      // Parse into a document fragment to avoid immediate script execution (safer)
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      // Move body children into a fragment
      const frag = document.createDocumentFragment();
      Array.from(doc.body.childNodes).forEach(node => frag.appendChild(node));
      // Clear container and append
      container.innerHTML = '';
      container.appendChild(frag);
    }

    // After injection, append a small tools strip (views + back link)
    function appendArticleTools(container, id){
      // remove existing if any
      const prev = container.querySelector('.article-tools-wrapper');
      if (prev) prev.remove();

      const wrap = document.createElement('div');
      wrap.className = 'article-tools-wrapper mt-3';
      wrap.innerHTML = `
        <div class="article-tools">
          <div class="small text-muted" id="articleToolsViewCount">Views: 0</div>
          <div><a class="btn btn-sm btn-outline-secondary" href="/articles.html">Back to list</a></div>
        </div>`;
      container.appendChild(wrap);
      updateViewUI(id);
    }

    // Extract light meta from injected DOM (if index isn't available)
    function extractMetaFromInjected(container){
      const titleEl = container.querySelector('h1') || container.querySelector('.display-4') || null;
      const authorEl = container.querySelector('.author') || container.querySelector('[data-author]') || null;
      const timeEl = container.querySelector('time[datetime]') || container.querySelector('time') || null;
      const categoryEl = container.querySelector('.article-meta .badge') || container.querySelector('.category') || null;
      const tagsEls = Array.from(container.querySelectorAll('.article-meta .badge')).slice(1); // heuristics
      return {
        title: titleEl ? titleEl.textContent.trim() : '',
        author: authorEl ? authorEl.textContent.trim() : '',
        date: timeEl ? (timeEl.getAttribute('datetime') || timeEl.textContent.trim()) : '',
        category: categoryEl ? categoryEl.textContent.trim().toLowerCase() : '',
        tags: tagsEls.map(n => n.textContent.trim().toLowerCase()).filter(Boolean)
      };
    }

    // Related computation: prefer using index JSON (metadata). If not available, fall back to meta from injected content.
    function computeRelatedFromIndex(index, meta){
      if (!index || !index.length) return [];
      const curId = String(meta.id);
      const candidates = index.filter(a => String(a.id) !== curId);
      // score by same category then shared tags
      const mTags = Array.isArray(meta.tags) ? meta.tags.map(t=>String(t).toLowerCase()) : [];
      const scored = candidates.map(a => {
        let score = 0;
        if (a.category && meta.category && String(a.category).toLowerCase() === String(meta.category).toLowerCase()) score += 10;
        const aTags = Array.isArray(a.tags) ? a.tags.map(t=>String(t).toLowerCase()) : [];
        const shared = aTags.filter(t => mTags.includes(t)).length;
        score += shared * 3;
        return { item: a, score };
      }).filter(x => x.score > 0);
      scored.sort((x,y) => (y.score - x.score) || (String(x.item.title).localeCompare(y.item.title)));
      return scored.slice(0,6).map(x => x.item);
    }
    function computeRelatedFallback(index, id){
      if (!index || !index.length) return [];
      // fallback only when there's no meta/category info at all
      return index.filter(a => String(a.id) !== String(id)).slice(0,6);
    }

    // Render related list
    function renderRelatedList(list){
      const el = qs('#relatedList');
      if (!el) return;
      // sanitize: remove any items missing valid id
      const sanitized = Array.isArray(list) ? list.filter(i => i && (i.id !== null && typeof i.id !== 'undefined') && String(i.id).trim() !== '') : [];
      if (!sanitized.length) {
        el.innerHTML = `<div class="small text-muted">No related articles found.</div>`;
        return;
      }
      el.innerHTML = sanitized.map(i => {
        // ensure safe strings and valid href
        const linkId = encodeURIComponent(String(i.id));
        const title = escapeHtml(i.title || 'Untitled');
        const author = escapeHtml(i.author || '');
        const date = escapeHtml(i.date || '');
        const category = escapeHtml(i.category || '');
        return `<a href="/article.html?id=${linkId}" class="list-group-item list-group-item-action related-item d-flex justify-content-between align-items-start">
                  <div style="flex:1;min-width:0">
                    <div class="fw-semibold text-truncate" style="max-width:200px">${title}</div>
                    <div class="small text-muted">${author}${author && date ? ' • ' : ''}${date}</div>
                  </div>
                  <div><small class="badge bg-secondary">${category}</small></div>
                </a>`;
      }).join('');
    }

    // Main loader: tries to fetch file, inject; if not found show prompt
    async function loadArticle(idOverride){
      const id = idOverride || currentIdFromURL();
      const container = qs('#articleContainer');
      if (!container) return;

      // initial loading UI
      qs('#loadingState')?.classList.remove('d-none');
      qs('#missingAlert')?.classList.add('d-none');
      container.innerHTML = `<div id="loadingState"><h1 id="articleTitle" class="h3 mb-2">Loading…</h1><div class="meta-muted mb-3">By <span id="articleAuthor">—</span> • <time id="articleDate">—</time></div><div class="lead">Loading content…</div></div>`;

      if (!id) {
        // no id → show message
        container.innerHTML = `<div class="alert alert-info">No article specified. Return to <a href="/articles.html">articles list</a>.</div>`;
        renderRelatedList([]);
        return;
      }

      // Attempt to fetch the article file
      const fetched = await fetchArticleHtmlById(id);
      if (!fetched) {
        // missing content
        container.innerHTML = ''; // clear
        qs('#missingAlert')?.classList.remove('d-none');
        // compute related from index *only if* index entry exists and has category/tags
        const idx = await fetchIndex();
        const metaFromIndex = (Array.isArray(idx) && idx.find(a => String(a.id) === String(id))) || null;
        let related = [];
        if (metaFromIndex && (metaFromIndex.category || (Array.isArray(metaFromIndex.tags) && metaFromIndex.tags.length))) {
          related = computeRelatedFromIndex(idx, metaFromIndex);
        } else {
          // explicit: no category → don't show unrelated articles; show empty state
          related = [];
        }
        renderRelatedList(related);
        return;
      }

      // inject fetched HTML
      injectHtmlIntoContainer(fetched.html, container);

      // append tools (views/back)
      appendArticleTools(container, id);

      // increment view count (we render only if fetched content present)
      incrementView(id);

      // Try to compute related items:
      const idx = await fetchIndex();
      // If index contains an entry for this id, use it; otherwise extract meta from injected DOM
      const metaFromIndex = (Array.isArray(idx) && idx.find(a => String(a.id) === String(id))) || null;
      const extracted = extractMetaFromInjected(container);
      const meta = Object.assign({ id }, (metaFromIndex || extracted));

      // New logic:
      // - If we have a category (either from index or extracted) compute by category/tags.
      // - If computeRelatedFromIndex returns empty → show "No related articles found."
      // - Only if we *have no category or tags at all* (rare), we may fall back to a generic list (or choose to show empty). For your requirement, prefer empty state.
      let related = [];
      if (meta && meta.category) {
        related = computeRelatedFromIndex(idx, meta);
      } else {
        // if article had no category, don't show unrelated items; show empty state
        related = [];
      }

      renderRelatedList(related);

      // set document title if not set by injected HTML
      if (!document.title || document.title === 'GYCO — Article') {
        const t = meta.title || container.querySelector('h1')?.textContent || `Article ${id}`;
        document.title = `GYCO — ${t}`;
      }
    }

    // Link interception: tally view before navigation for article links on this page
    document.addEventListener('click', function (e) {
      const link = e.target.closest('a[href*="article.html?id="]');
      if (!link) return;
      try {
        const url = new URL(link.getAttribute('href'), location.href);
        if (url.origin !== location.origin) return;
        const id = url.searchParams.get('id');
        if (!id) return;
        // record then navigate
        e.preventDefault();
        incrementView(id);
        location.href = link.href;
      } catch (err) { /* ignore */ }
    });

    // Search: redirect to articles list
    qs('#searchForm')?.addEventListener('submit', function (ev) {
      ev.preventDefault();
      const q = (qs('#searchInput')?.value || '').trim();
      const dest = new URL('/articles.html', location.origin);
      if (q) dest.searchParams.set('q', q);
      location.href = dest.href;
    });

    // Request form demo behavior + toast
    const form = qs('#requestForm');
    const toastEl = qs('#submitToast');
    const toast = toastEl ? new bootstrap.Toast(toastEl, { autohide:true, delay:2200 }) : null;
    if (form) {
      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        ev.stopPropagation();
        if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
        const modal = bootstrap.Modal.getInstance(qs('#requestModal'));
        if (modal) modal.hide();
        form.reset();
        form.classList.remove('was-validated');
        if (toast) toast.show();
      });
    }

    // Nav activation on load & popstate
    document.addEventListener('DOMContentLoaded', function () {
      activateNavLinks();
      loadArticle(); // auto-load current id
    });
    window.addEventListener('popstate', activateNavLinks);

    // Expose API
    window.ArticlePage = { loadArticle };

  })();
  </script>
</body>
</html>
